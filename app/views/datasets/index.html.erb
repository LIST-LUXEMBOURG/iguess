<div>
  <h1 class="page_header">Registered Datasets</h1>

  <form id="filter-form">Filter: <input name="filter" id="filter" value="" maxlength="30" size="30" type="text"></form>

  <div class="hint">Hint: Filter table by typing in the box above; sort by clicking on column headers; use Ctrl to sort by multiple columns</div>

  <table id="sortable_table" class="zebra sortable">
    <thead>
      <tr><th>Name</th><th>Tags</th><th>Published?</th><th class="center">Status</th></tr>
    </thead>
    <tbody id="dataset-list">
      <% @datasets.each do |d| %>
        <tr>
          <td>
            <%= d.title.present? ? d.title : d.identifier %>
            <img src="/assets/small_question_mark.gif" class="info-icon" 
                  alt="More info" title="Click for details" rel="#infotable-<%= d.id %>">
          </td>
          <td>
            <% d.dataset_tags.each do |t| %>
              <span class="tag"><%= t.tag %></span>
            <% end %>
          </td>
          <td>
            <label>
              <span>
                <!-- Create a hidden span to allow sorting by checkbox status -->
                <span class="sortcol hidden" id="cb-<%= d.id %>"><%= d.published ? "1" : "2" %></span>  
                <input class="publish-checkbox" data-datasetid="<%= d.id %>" id="x-<%= d.id %>"
                       type="checkbox" <%= d.published ? raw('checked="yes"') : "" %> >Publish
              </span>
            </label>
          </td>
          <td nowrap>
            <span class="hidden"><%= d.alive ? "1" : "2" %></span>      <!-- Hidden span allows sorting by availability -->
              <%= d.alive ? raw('<img class="status-indicator" src="/assets/layer_available_yes.png" alt="Layer available">') :
                            raw('<img class="status-indicator" src="/assets/layer_available_no.png"  alt="Layer not available">') %></td>
        </tr>
      <% end%>
    </tbody>
  </table>

  <div id="infotables">
    <!-- Create the popups that are displayed when the user clicks (?) -->
    <% @datasets.each do |d| %>
      <div class="infotable" id="infotable-<%= d.id %>">
        <div class="close"></div>
        <h1><span class="dataset-title"><%= d.title.present? ? d.title : d.identifier %></h1>
        <div class="dataset-descr-<%= d.id %>"></div> 
        <div style="overflow:hidden"><dl>
          <dt>Server Name:</dt><dd class="server-name"><%= d.dataserver.title %></dd>
           <dt>Data Services:</dt><dd id="results-<%= d.id %>">Waiting for response from server...</dd>
           <dt>Tags:</dt><dd><span class="taglist-deletable-<%= d.id %>"></span>
             <span><% d.dataset_tags.each do |t| %>
                <span class="tag">
                  <span class="tag-delete-button" data-url="<%= d.dataserver.url %>" data-identifier="<%= d.identifier %>"></span>
                  <%= t.tag %></span>
              <% end %>
            </span>
            
              <select style="float:right" class="add-tag-dropdown-control" 
                data-serverurl="<%= d.dataserver.url %>"
                data-datasetidentifier="<%= d.identifier %>" 
                onchange="tagPickerChanged($(this));"> 

                <option value = "Ignore This">Add Tag:</option>
                <% if d.dataserver.wms %>
                  <option value="Mapping">Mapping</option>
                <% end %>

                <% d.dataset_tags.each do |t| %>
                  <option value="<%= t.tag %>"><%= t.tag %></option>
                <% end %>
           </select>
        </dl></div>
        <div style="overflow:hidden" class="technical-details">
          <div class="technical-details-header">Technical Details</div><dl>
          <dt>Server Base URL:</dt><dd><%= d.server_url %></dd>
          <dt>Dataset Identifier:</dt><dd><%= d.identifier %></dd>
          <dt>All Get Capabilities Links:</dt><dd>
              <a href=" + WFS.getCapUrl(dataset.server_url) + " target="_blank">WFS</a>
              <a href=" + WMS.getCapUrl(dataset.server_url) + " target="_blank">WMS</a> 
              <a href=" + WCS.getCapUrl(dataset.server_url) + " target="_blank">WCS</a>
          </dd>
          <dt>Projections Available:</dt><dd></dd> 
          <dt>Bounding Box:</dt><dd></dd>
          <dt>Attribute Columns:</dt><dd></dd>
        </dl></div>
        <div><a href="javascript:void(0);" class="show-details"></a></div>
      </div>
    <% end %>
  </div>

  <%= button_to "Register Datasets", :controller => 'datasets', :action => 'mass_import', :id => 1 %>

  <br />
</div>




<script type="text/javascript">
 $(document).ready(function() {
    onLocationChanged('<%= @current_city.name %>');   // Build the initial dataset list
    $('#sortable_table').tablesorter();               // Initialize sorter
  });
</script>

<%= render :partial => '/shared/build_registered_layers.html.erb' %>  <%# Builds registeredDataLayers structure %>

<%# Include some map related utility functions; these need to be processed by Rails so they have to be in a partial %>
<%= render :partial => '/shared/map_utils.html.erb' %>
<%= render :partial => '/shared/dataset_functions.html.erb' %>


<script type="text/javascript">

  // $('a.popup[rel]').overlay();                         // Activate popups for managing dataset tags 
  $('img[rel]').overlay();                             // Set up the layer info overlays
  $('img[rel]').click(function(){ hideDetails(); });   // Close details panel on open

  $('.show-details').click(function() { showDetails(); });
  $('.publish-checkbox').click(function() { publishDataset(this); });

  // Initiate collection of data tags -- visit each WPS server to see what tags are in use
  // This will ultimately populate the DataTagList[] array
  collectTags([<%= @wps_servers.map{ |w| "'" + w.url + "'" }.join(',') %>]);


  var publishDataset = function(ctrl) {
    var datasetId = ctrl.getAttribute('data-datasetid');
    var checked   = ctrl.checked;

    // Set sort column contents to checkboxes will sort properly
    var el = $("#cb-" + datasetId);
    el.html(checked ? "1" : "2");

    el.parents("table").trigger("update"); 


    // Notify the server
    $.ajax({
      type:    'PUT',      // PUT combined with url below triggers "update" action on controller
      url:     '<%= url_for(:controller => 'datasets', :action => 'publish') %>',
      data:    'dataset[id]=' + datasetId +
               '&checked='    + checked,
      headers: { 'X-CSRF-Token': '<%= form_authenticity_token.to_s %>' /*,
                 'Content-Type': 'application/json' */},
      success: function(data) {  }
    });
  };


// Make sure table is sorted
var sorting = [[1,0], [0,0]]; 
// sort on the first column 

$('#sortable_table').trigger("update"); 
$('#sortable_table').trigger("sorton",[sorting]); 


  var onLocationChanged = function(cityName) {
    MapUtils.retrieveDatasetsForCity(cityName, function(dataset) { renderTable(dataset);
                                                                   hideUnregisterAndFriends(); });
  };


  // Gets run when user clicks on the Links tag to the right of the main table
  // Never used?
  var tagLinkClicked = function(urlId) {
    var tags = [];

    $('#taglist-' + urlId).children().each(function() {
        tags.push($(this).text());
    });

  };


  $(document).bind('ajax:success', function(xhr, data, status) { 
    $('#dataset-id-' + data).hide();
  });


  $(function() {
    var theTable = $('#sortable_table')

    theTable.find("tbody > tr").find("td:eq(1)").mousedown(function(){
      $(this).prev().find(":checkbox").click()
    });

    $("#filter").keyup(function() {
      $.uiTableFilter( theTable, this.value );
    })

    $('#filter-form').submit(function(){
      theTable.find("tbody > tr:visible > td:eq(1)").mousedown();
      return false;
    }).focus(); //Give focus to input field
  });
</script>






